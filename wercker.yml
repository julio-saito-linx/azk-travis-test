box: wercker-labs/docker
build:
  steps:

    - script:
        name: configure Docker 1.2.0
        code: |
          sudo groupadd docker -f
          sudo gpasswd -a ${USER} docker

    - script:
        name: install libnss-resolver
        code: |
          sudo apt-key adv --keyserver keys.gnupg.net --recv-keys 022856F6D78159DF43B487D5C82CF0628592D2C9
          echo "deb [arch=amd64] http://repo.azukiapp.com trusty main" | sudo tee /etc/apt/sources.list.d/azuki.list
          sudo apt-get update -y
          sudo apt-get install libnss-resolver -y

    - script:
        name: /etc/resolver/azk.dev
        code: |
          sudo mkdir -p /etc/resolver
          sudo touch /etc/resolver/azk.dev
          echo "nameserver 172.17.42.1:53" | sudo tee -a /etc/resolver/azk.dev

    - script:
        name: docker version
        code: |
          docker -v

    - script:
        name: docker processes
        code: |
          docker ps

    - script:
        name: make
        code: |
          make

    - script:
        name: azk version
        code: |
          export AZK_DEBUG=debug
          bin/azk version

    # - script:
    #     name: azk agent start
    #     code: |
    #       bin/azk agent start

    - script:
        name: azk agent start --no-daemon &
        code: |
          bin/azk agent start --no-daemon &

    - script:
        name: sleep 10
        code: |
          sleep 10

    - script:
        name: 01-run-slow-tests.sh
        code: |
          bin/azk shell package -c 'bash ./package-creation/01-run-slow-tests.sh'


