box: wercker-labs/docker
build:
  steps:

    - script:
        name: configure Docker 1.2.0
        code: |
          sudo groupadd docker -f
          sudo gpasswd -a ${USER} docker

    - script:
        name: install libnss-resolver
        code: |
          sudo apt-key adv --keyserver keys.gnupg.net --recv-keys 022856F6D78159DF43B487D5C82CF0628592D2C9
          echo "deb [arch=amd64] http://repo.azukiapp.com trusty main" | sudo tee /etc/apt/sources.list.d/azuki.list
          sudo apt-get update -y
          sudo apt-get install libnss-resolver -y

    - script:
        name: /etc/resolver/azk.dev
        code: |
          sudo mkdir -p /etc/resolver
          sudo touch /etc/resolver/azk.dev
          echo "nameserver 172.17.42.1:53" | sudo tee -a /etc/resolver/azk.dev

    - script:
        name: docker version
        code: |
          docker -v

    - script:
        name: docker processes
        code: |
          docker ps

    - script:
        name: make
        code: |
          make

    - script:
        name: azk version
        code: |
          export AZK_DEBUG=debug
          bin/azk version

    # - script:
    #     name: azk agent start
    #     code: |
    #       bin/azk agent start

    - script:
        name: azk agent start
        code: |
          bin/azk agent start --no-daemon > azk-agent-start.log 2>&1 &

    - script:
        name: 00- wait-agent-to-start
        code: |
          bash ./package-creation/00-wait-agent-to-start.sh

    # - script:
    #     name: show agent status
    #     code: |
    #       echo "azk agent status:"
    #       cat azk-agent-start.log

    - script:
        name: download some docker images
        code: |
          docker pull azukiapp/fpm
          docker pull azukiapp/azktcl:0.0.2

    - script:
        name: azk nvm grunt slow_test
        code: |
          bin/azk nvm grunt slow_test

    - script:
        name: making linux packages
        code: |
          make package_deb
          make package_rpm

    - script:
        name: package-deb
        code: |
          export VERSION=0.7.1
          export DISTRO=precise
          export REPO=azk-${DISTRO}
          bin/azk shell package -c "pwd"
          bin/azk shell package -c "ls -la"
          bin/azk shell package -c "sh package-creation/21-package-deb-12.sh" -e AZK_VERSION=$AZK_VERSION

